openapi: 3.1.0
info:
  title: LatinPay API
  description: |
    API REST para gestionar Pedidos (Orders) y Pagos (Payments) con integración a gateway externo.
    
    ## Características principales
    - Crear y consultar pedidos
    - Procesar pagos mediante API externa (Beeceptor)
    - Validación estricta del monto
    - Reintentos permitidos en pedidos fallidos
    - **Idempotencia en pagos** mediante header `Idempotency-Key`
    - **Auditoría completa** de intentos de pago
    - Logging completo de transacciones
    
    ## Idempotencia
    Para evitar cobros duplicados, incluye el header `Idempotency-Key` con un UUID v4.
    Si el mismo key se reenvía, se devolverá la misma respuesta sin re-procesar.
    
    ## Auditoría
    Todos los intentos de pago se registran en `payment_attempts` con IP, user agent,
    payloads completos y errores. Útil para detección de fraude, debugging y compliance.
  version: 1.0.0
  contact:
    name: LatinPay API Support
    email: support@latinpay.com

servers:
  - url: http://localhost:8000/api
    description: Servidor de desarrollo local

tags:
  - name: Orders
    description: Operaciones sobre pedidos
  - name: Payments
    description: Operaciones sobre pagos y auditoría de intentos

paths:
  /orders:
    get:
      tags:
        - Orders
      summary: Listar todos los pedidos
      description: Obtiene una lista de todos los pedidos con sus pagos asociados y contador de intentos
      operationId: listOrders
      responses:
        '200':
          description: Lista de pedidos obtenida exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/OrderWithPayments'
              examples:
                success:
                  value:
                    data:
                      - id: 1
                        customer_name: "Marco Polo"
                        amount: "150.50"
                        status: "paid"
                        payments_count: 1
                        created_at: "2025-11-15T10:30:00.000000Z"
                        updated_at: "2025-11-15T10:35:00.000000Z"
                        payments:
                          - id: 1
                            order_id: 1
                            amount: "150.50"
                            status: "success"
                            gateway_response:
                              id: 123
                              createdAt: "2025-11-15T10:35:00Z"
                            idempotency_key: null
                            created_at: "2025-11-15T10:35:00.000000Z"
                            updated_at: "2025-11-15T10:35:00.000000Z"
                      - id: 2
                        customer_name: "María González"
                        amount: "300.00"
                        status: "pending"
                        payments_count: 0
                        created_at: "2025-11-15T11:00:00.000000Z"
                        updated_at: "2025-11-15T11:00:00.000000Z"
                        payments: []

    post:
      tags:
        - Orders
      summary: Crear un nuevo pedido
      description: Crea un pedido nuevo con estado "pending"
      operationId: createOrder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
            examples:
              example1:
                value:
                  customer_name: "Marco Polo"
                  amount: 150.50
      responses:
        '201':
          description: Pedido creado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Order'
              examples:
                success:
                  value:
                    data:
                      id: 1
                      customer_name: "Marco Polo"
                      amount: "150.50"
                      status: "pending"
                      payments_count: 0
                      created_at: "2025-11-15T10:30:00.000000Z"
                      updated_at: "2025-11-15T10:30:00.000000Z"
        '422':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              examples:
                validation_error:
                  value:
                    message: "The customer name field is required. (and 1 more error)"
                    errors:
                      customer_name:
                        - "The customer name field is required."
                      amount:
                        - "The amount field is required."

  /orders/{id}:
    get:
      tags:
        - Orders
      summary: Obtener un pedido específico
      description: Obtiene los detalles de un pedido por su ID, incluyendo todos sus pagos
      operationId: getOrder
      parameters:
        - name: id
          in: path
          required: true
          description: ID del pedido
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Pedido obtenido exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/OrderWithPayments'
        '404':
          description: Pedido no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                not_found:
                  value:
                    message: "No query results for model [App\\Models\\Order] 999"

  /orders/{order}/payments:
    post:
      tags:
        - Payments
      summary: Procesar un pago para un pedido
      description: |
        Procesa un pago para un pedido específico mediante gateway externo.
        
        ## Idempotencia
        Incluye el header `Idempotency-Key` con un UUID v4 para evitar pagos duplicados.
        Si se reenvía el mismo key, se devolverá el mismo pago sin re-procesarlo.
        
        ## Validaciones
        - El monto debe coincidir exactamente con el monto del pedido
        - El pedido debe existir
        
        ## Estados
        - Si el gateway responde 2xx → `success`, pedido pasa a `paid`
        - Si el gateway falla → `failed`, pedido pasa a `failed`
        - Se permiten reintentos en pedidos `failed`
      operationId: processPayment
      parameters:
        - name: order
          in: path
          required: true
          description: ID del pedido
          schema:
            type: integer
            example: 1
        - name: Idempotency-Key
          in: header
          required: false
          description: UUID v4 para idempotencia (opcional pero recomendado)
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessPaymentRequest'
            examples:
              with_idempotency:
                summary: Con idempotency key (recomendado)
                value:
                  amount: 150.50
              without_idempotency:
                summary: Sin idempotency key
                value:
                  amount: 150.50
      responses:
        '201':
          description: Pago procesado exitosamente (nuevo pago)
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Payment'
              examples:
                success:
                  value:
                    data:
                      id: 1
                      order_id: 1
                      amount: "150.50"
                      status: "success"
                      gateway_response:
                        id: 123
                        createdAt: "2025-11-15T10:35:00Z"
                      idempotency_key: "550e8400-e29b-41d4-a716-446655440000"
                      created_at: "2025-11-15T10:35:00.000000Z"
                      updated_at: "2025-11-15T10:35:00.000000Z"
                failed:
                  value:
                    data:
                      id: 2
                      order_id: 2
                      amount: "200.00"
                      status: "failed"
                      gateway_response:
                        error: "Gateway timeout"
                      idempotency_key: "661e9511-f3ac-52e5-b827-557766551111"
                      created_at: "2025-11-15T11:00:00.000000Z"
                      updated_at: "2025-11-15T11:00:00.000000Z"
        '200':
          description: Pago existente devuelto (idempotencia activada)
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Payment'
              examples:
                idempotent_response:
                  value:
                    data:
                      id: 1
                      order_id: 1
                      amount: "150.50"
                      status: "success"
                      gateway_response:
                        id: 123
                        createdAt: "2025-11-15T10:35:00Z"
                      idempotency_key: "550e8400-e29b-41d4-a716-446655440000"
                      created_at: "2025-11-15T10:35:00.000000Z"
                      updated_at: "2025-11-15T10:35:00.000000Z"
        '404':
          description: Pedido no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              examples:
                amount_mismatch:
                  value:
                    message: "El monto del pago no es válido."
                    errors:
                      amount:
                        - "El monto del pago debe coincidir exactamente con el monto del pedido."
                invalid_amount:
                  value:
                    message: "The amount field is required."
                    errors:
                      amount:
                        - "The amount field is required."
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                server_error:
                  value:
                    message: "Error procesando el pago"
                    errors:
                      payment:
                        - "Connection timeout to payment gateway"

  /orders/{order}/payment-attempts:
    get:
      tags:
        - Payments
      summary: Obtener historial de intentos de pago
      description: |
        Devuelve todos los intentos de pago para un pedido específico, ordenados por fecha descendente.
        Incluye intentos exitosos, fallidos, rechazados y duplicados.
        
        **Nota de seguridad:** Este endpoint es para auditoría interna. 
      operationId: getPaymentAttempts
      parameters:
        - name: order
          in: path
          required: true
          description: ID del pedido
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Historial de intentos obtenido exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PaymentAttempt'
              examples:
                success:
                  value:
                    data:
                      - id: 3
                        order_id: 1
                        payment_id: null
                        amount: "200.00"
                        status: "error"
                        idempotency_key: null
                        ip_address: "192.168.1.100"
                        user_agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
                        request_payload:
                          amount: 200.00
                        response_payload: null
                        error_message: "El monto del pago no coincide con el monto del pedido"
                        created_at: "2025-11-16T10:35:00.000000Z"
                      - id: 2
                        order_id: 1
                        payment_id: null
                        amount: "150.50"
                        status: "error"
                        idempotency_key: "abc-123-different"
                        ip_address: "192.168.1.100"
                        user_agent: "PostmanRuntime/7.29.2"
                        request_payload:
                          amount: 150.50
                        response_payload: null
                        error_message: "Intento de pago en pedido ya pagado"
                        created_at: "2025-11-16T10:32:00.000000Z"
                      - id: 1
                        order_id: 1
                        payment_id: 1
                        amount: "150.50"
                        status: "success"
                        idempotency_key: "550e8400-e29b-41d4-a716-446655440000"
                        ip_address: "192.168.1.100"
                        user_agent: "curl/7.68.0"
                        request_payload:
                          amount: 150.50
                        response_payload:
                          id: 123
                          createdAt: "2025-11-16T10:30:00Z"
                        error_message: null
                        created_at: "2025-11-16T10:30:00.000000Z"
        '404':
          description: Pedido no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /payments/{id}:
    get:
      tags:
        - Payments
      summary: Obtener un pago específico
      description: Obtiene los detalles de un pago por su ID
      operationId: getPayment
      parameters:
        - name: id
          in: path
          required: true
          description: ID del pago
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Pago obtenido exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Payment'
              examples:
                success:
                  value:
                    data:
                      id: 1
                      order_id: 1
                      amount: "150.50"
                      status: "success"
                      gateway_response:
                        id: 123
                        createdAt: "2025-11-15T10:35:00Z"
                      idempotency_key: "550e8400-e29b-41d4-a716-446655440000"
                      created_at: "2025-11-15T10:35:00.000000Z"
                      updated_at: "2025-11-15T10:35:00.000000Z"
        '404':
          description: Pago no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                not_found:
                  value:
                    message: "No query results for model [App\\Models\\Payment] 999"

components:
  schemas:
    Order:
      type: object
      properties:
        id:
          type: integer
          example: 1
        customer_name:
          type: string
          example: "Marco Polo"
        amount:
          type: string
          description: Monto del pedido en formato decimal (2 decimales)
          example: "150.50"
        status:
          type: string
          enum: [pending, paid, failed]
          description: |
            - `pending`: Pedido creado, sin pagos exitosos
            - `paid`: Pago exitoso procesado
            - `failed`: Todos los intentos de pago fallaron
          example: "pending"
        payments_count:
          type: integer
          description: Número total de intentos de pago
          example: 0
        created_at:
          type: string
          format: date-time
          example: "2025-11-15T10:30:00.000000Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-11-15T10:30:00.000000Z"

    OrderWithPayments:
      allOf:
        - $ref: '#/components/schemas/Order'
        - type: object
          properties:
            payments:
              type: array
              items:
                $ref: '#/components/schemas/Payment'

    Payment:
      type: object
      properties:
        id:
          type: integer
          example: 1
        order_id:
          type: integer
          example: 1
        amount:
          type: string
          description: Monto del pago en formato decimal (2 decimales)
          example: "150.50"
        status:
          type: string
          enum: [success, failed]
          description: |
            - `success`: Pago procesado exitosamente por el gateway
            - `failed`: Gateway rechazó o no pudo procesar el pago
          example: "success"
        gateway_response:
          type: object
          description: Respuesta completa del gateway de pagos externo
          additionalProperties: true
          example:
            id: 123
            createdAt: "2025-11-15T10:35:00Z"
        idempotency_key:
          type: string
          format: uuid
          nullable: true
          description: UUID v4 para prevenir pagos duplicados
          example: "550e8400-e29b-41d4-a716-446655440000"
        created_at:
          type: string
          format: date-time
          example: "2025-11-15T10:35:00.000000Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-11-15T10:35:00.000000Z"

    CreateOrderRequest:
      type: object
      required:
        - customer_name
        - amount
      properties:
        customer_name:
          type: string
          maxLength: 255
          description: Nombre del cliente
          example: "Marco Polo"
        amount:
          type: number
          format: float
          minimum: 0.01
          description: Monto del pedido (mínimo 0.01)
          example: 150.50

    ProcessPaymentRequest:
      type: object
      required:
        - amount
      properties:
        amount:
          type: number
          format: float
          minimum: 0.01
          description: Monto del pago (debe coincidir exactamente con el monto del pedido)
          example: 150.50

    ValidationError:
      type: object
      properties:
        message:
          type: string
          example: "The customer name field is required. (and 1 more error)"
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          example:
            customer_name:
              - "The customer name field is required."
            amount:
              - "The amount field is required."

    Error:
      type: object
      properties:
        message:
          type: string
          example: "Error message description"

    PaymentAttempt:
      type: object
      properties:
        id:
          type: integer
          example: 1
        order_id:
          type: integer
          example: 1
        payment_id:
          type: integer
          nullable: true
          description: ID del pago creado (solo si el intento fue exitoso)
          example: 1
        amount:
          type: string
          description: Monto del intento en formato decimal (2 decimales)
          example: "150.50"
        status:
          type: string
          enum: [success, failed, error]
          description: |
            - `success`: Pago procesado exitosamente
            - `failed`: Gateway rechazó el pago
            - `error`: Error de validación o duplicado
          example: "success"
        idempotency_key:
          type: string
          format: uuid
          nullable: true
          description: UUID usado en el intento (si aplica)
          example: "550e8400-e29b-41d4-a716-446655440000"
        ip_address:
          type: string
          nullable: true
          description: Dirección IP del cliente
          example: "192.168.1.100"
        user_agent:
          type: string
          nullable: true
          description: User agent del navegador/aplicación
          example: "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
        request_payload:
          type: object
          nullable: true
          description: Payload completo de la petición
          additionalProperties: true
          example:
            amount: 150.50
        response_payload:
          type: object
          nullable: true
          description: Respuesta del gateway (si aplica)
          additionalProperties: true
          example:
            id: 123
            createdAt: "2025-11-16T10:30:00Z"
        error_message:
          type: string
          nullable: true
          description: Mensaje de error detallado (si aplica)
          example: "El monto del pago no coincide con el monto del pedido"
        created_at:
          type: string
          format: date-time
          example: "2025-11-16T10:30:00.000000Z"
